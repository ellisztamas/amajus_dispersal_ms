library(tidyverse)
library(ggpubr)

files <- Sys.glob("03_analysis/04_mating_events/output/*/summarise_mating.csv")

me <- read_csv("03_analysis/04_mating_events/output/01_mcmc_main/summarise_mating.csv")

me

# Import mating events from multiple scenarios
mating_summary <- lapply(files, function(dir) {
  read_csv(dir, col_types = 'dddddd') %>%
    mutate(scenario = strsplit(dir, split = "/")[[1]][[4]])
}) %>% 
  do.call(what = "rbind") %>% 
  # Calculate a proportion of missing sires
  mutate(
    missing_dads = missing_dads / (missing_dads + n_mating_events)
  ) %>% 
  # Change the names for each analysis to something human readable
  mutate(
    scenario = recode_factor(
      scenario,
      `02_mcmc_022_missing_fathers` = "q=0.22",
      `01_mcmc_main` = "q=0.32",
      `03_mcmc_042_missing_fathers` = "q=0.42"#,
      # `04_no_mixture` = "No mixture"
      )
  ) %>% 
  # Get means and 96% credible intervals
  pivot_longer(n_mating_events: orphans, names_to = "parameter") %>% 
  group_by(parameter, scenario) %>% 
  summarise(
    mean = mean(value),
    lower = quantile(value, 0.02),
    upper = quantile(value, 0.98),
    .groups = "drop_last"
  )

plot_n_mating_events <- mating_summary %>% 
  filter(parameter == "n_mating_events") %>% 
  ggplot(aes( y = mean, x = scenario)) +
  geom_point() +
  geom_errorbar(aes( ymin=lower, ymax=upper), width=0.1 ) +
  labs(
    x = element_blank(),
    y = "Number of mating events"
  ) +
  theme_bw() +
  theme( axis.text.x = element_blank() )

plot_missing_sires <- mating_summary %>% 
  filter(parameter == "missing_dads") %>% 
  ggplot(aes( y = mean, x = scenario)) +
  geom_point() +
  geom_errorbar(aes( ymin=lower, ymax=upper), width=0.1 ) +
  labs(
    x = element_blank(),
    y = "Missing fathers"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8)
  )

plot_mating_events <- ggarrange(plot_n_mating_events, plot_missing_sires,
          nrow = 2, heights = c(1,1.4), labels = "AUTO")

ggsave(
  filename = "05_manuscript/mating_events.eps",
  device = "eps",
  width = 8, height = 15, units = "cm",
  plot = plot_mating_events
)
